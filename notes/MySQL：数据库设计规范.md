## 数据库设计规范

### 1. 数据库命名规范
- 所有数据库对象名称必须使用小写字母并用下划线分割；（mysql区分大小写）
- 所有数据库对象名称禁止使用MySQL保留关键字；（from）
- 数据库对象的命名要能做到见名识义，并且最好不要超过32个字符；
- 临时库表必须以tmp为前缀并以日期为后缀；
- 备份库，备份表必须以bak为前缀并以日期为后缀；
- 所有存储相同数据的列名和列类型必须一致；

### 2. 数据库基本设计规范
- 所有表必须使用 Innodb 存储引擎；
  - MySQL5.5使用之前Myisam（默认存储引擎）情况；
  - 5.6 以后的默认引擎（Innodb）；
  - Innodb 支持事务、行级锁，更好的恢复性，高并发下性能更好；
- 数据库和表的字符集统一使用UTF8；
  - UTF8 兼容性更好；
  - 统一字符集可以避免由于字符集转换产生乱码；
  - MySQL 中 UTF8 字符集 汉字占3个字节，ASCII码占用1个字节；
- 所有表和字段都需要添加注释；
  - 使用 comment 从句添加表和列的备注；
  - 从一开始就进行数据字典的维护；
- 尽量控制单表数据量的大小，建议控制在 500 万以内；
  - 500万并不是MySQL数据库的限制；
  - 修改表结构、备份、恢复都会有很大的问题；
  - MySQL最多可存储多少数据，取决于存储设置和文件系统；
  - 可以用历史数据归档、分库分表等手段来控制数据量大小；
- 谨慎使用MySQL分区表
  - 分区表在物理上表现为多个文件，在逻辑上表现为一个表；
  - 谨慎选择分区键，跨分区查询效率可能更低；
  - 建议采用物理分表的方式管理大数据；
- 尽量做到冷热数据分离，减小表的宽度（MySQL限制最多存储4096列）
  - 减少磁盘IO，保证热数据的内存缓存命中率
  - 更有效的利用缓存，避免读入无用的冷数据；
  - 经常一起使用的列放到一个表中；
- 禁止在表中建立预留字段；
  - 预留字段的命名很难做到见名识义
  - 预留字段无法确认存储的数据类型，所以无法选择合适的类型
  - 对预留字段类型的修改，会对表进行锁定；
- 禁止在数据库中存储图片、文件等二进制数据
- 禁止在线上做数据库压力测试
- 禁止从开发环境、测试环境直连生产环境数据库

### 3. 数据库索引设计规范
- 限制每张表上的索引数量，建议单张表索引不超过5个
  - 索引并不是越多越好！索引可以提高效率同样可以降低效率
  - 索引可以增加查询效率，但同样也会降低插入和更新的效率
  - 禁止给表中的每一列都建立单独的索引
- 每个Innodb表必须有一个主键
  - Innodb按照主键的顺序来组织表的
  - 不使用更新频繁的列作为主键，不使用多列主键
  - 不使用UUID、MD5、HASH、字符串列作为主键
  - 主键建议选择使用自增ID值
- 常见索引列建议
  - select、update、delete语句的where从句中的列
  - 包含在order by、group by、distinct中的字段
  - 多表 join 的关联列
- 如何选择索引列的顺序（从左到右的顺序来使用的）
  - 区分度最高的列放在联合索引的最左侧
  - 尽量把字段长度小的列放在联合索引的最左侧
  - 使用最频繁的列放到联合索引的左侧
- 避免建立冗余索引和重复索引
  - 重复索引：primary key(id)、index(id)、unique index(id)
  - 冗余索引：index(a,b,c)、index(a,b)、index(a)
- 对于频繁的查询尤溪县考虑使用覆盖索引
  - 覆盖索引：就是包含了所有查询字段的索引；
  - 避免 Innodb 表进行索引的二次查找
  - 可以把随机 IO 变为顺序 IO 加快查询效率
- 尽量避免使用外键
  - 不建议使用外键约束，但一定在表与表之间的关联键上建立索引
  - 外键可用于保证数据的参照完整性，但建议在业务端实现
  - 外键会影响父表和子表的写操作从而降低性能

### 4. 数据库字段设计规范
- 优先选择符合存储需要的最小的数据类型
  - 将字符串转化为数字类型存储
	  ```sql
	     INET_ATON('255.255.255.255') = 4294967295
	     INET_NTOA(4294967295) = '255.255.255.255'
	  ```
  - 对于非负型的数据来书，要先使用无符号整型来存储
    - 无符号相对于有符号可以多出一倍的存储空间
    ```sql
     SIGNED INT -2147483648 ~ 2147483647
     UNSIGNED INT 0 ~ 4294967295
    ```
  - VARCHAR(N) 中的 N 代表的是字符数，而不是字节数
  - 使用UTF8存储汉字 varchar(255) = 765 个字节
  - 过大的长度会消耗更多的内存
- 避免使用TEXT、BLOB数据类型（TinyText、Text、MidumText、LongText）
  - 建议把 BLOB 或是 TEXT 列分离到单独的扩展表中
  - TEXT 或 BLOB 类型只能使用前缀索引
- 避免使用 ENUM 数据类型
  - 修改 ENUM 值需要使用 ALTER 语句
  - ENUM 类型的 ORDER BY 操作效率低，需要额外操作
  - 禁止使用数值作为 ENUM 的枚举值
- 尽可能把所有列定义为 NOT NULL
  - 索引 NULL 列需要额外的空间来保存，所以要占用更多的空间
  - 进行比较和计算时要对 NULL 值做特别的处理
- 字符串存储日期型的数据（不正确的做法）
  - 缺点1：无法用日期函数进行计算和比较
  - 缺点2：用字符串存储日期要占用更多的空间
- 使用 TIMESTAMP 或 DATETIME 类型存储时间
  - TIMESTAMP  1970-01-01 00:00:01 ~ 2038-01-19 03:14:07
  - TIMESTAMP 占用4字节和INT相同，但比INT可读性高
  - 超出 TIMESTAMP  取值范围的使用 DATETIME 类型
- 同财务相关的金额类数据，必须使用 decimal 类型（非精准浮点：float、double；精准浮点：decimal）
  - decimal 类型为精准浮点数，在计算时不会丢失精度
  - 占用空间由定义的宽度决定
  - 可用于存储比bigint更大的整数数据

### 5. 数据库SQL开发规范
- 建议使用预编译语句进行数据库操作
  - 只传参数，比传递 SQL 语句更高效
  - 相同语句可以一次解析，多次使用，提高处理效率
- 避免数据类型的隐式转换
  - 隐式转换会导致索引失效
	```sql
	select name,phone, from customer where id = '111'
	```
- 合理利用存在索引，而不是盲目增加索引（充分利用表上已经存在的索引）
  - 避免使用双%号的查询条件。如 a like '%123%'
  - 一个SQL只能利用到复合索引中的一列进行范围查询
  - 使用 left join 或 not exists 来优化 not in 操作（使用 not in 索引会失效）
- 程序连接不同的数据库使用不同的账号，禁止跨库查询
  - 为数据库迁移和分库分表留出余地
  - 降低业务耦合度
  - 避免权限过大而产生的安全风险
- 禁止使用 `SELECT *` 必须使用 `SELECT <字段列表>` 查询
  - 消耗更多的 CPU 和 IO以及网络带宽资源
  - 无法使用覆盖索引
  - 可减少表结构变更带来的影响
- 禁止使用不含字段列表的 INSERT 语句
	```sql
	#错误写法
	insert into values('a','b','c');
	#正确写法
	insert into t(c1,c2,c3) values('a','b','c');
    ```
- 避免使用子查询，可以把子查询优化为 join 操作
  - 子查询的结果集无法使用索引
  - 子查询会产生临时表操作，如果子查询数据量大则严重影响效率
  - 消耗过多的 CPU 和 IO 资源
- 避免使用 JOIN 关联太多的表
  - 每 join 一个表会多占用一部分内存(join_buffer_size)
  - 会产生临时表操作，影响查询效率
  - MySQL最多允许关联61个表，建议不超过5个
- 减少同数据库的交互次数
  - 数据库更适合处理批量操作
  - 合并多个相同的操作到一起，可以提高处理效率
- 使用 in 代替 or
  - in 的值不要超过500个
  - in 操作可以有效的利用索引
- 禁止使用`order by rand()` 进行随机排序
  - 会把表中所有符合条件的数据装载到内存中进行排序
  - 会消耗大量的 CPU 和 IO 及内存资源
  - 推荐在程序中获取一个随机值，然后从数据库中获取数据的方式
- where 从句中禁止队列进行函数转换和计算
  - 对列进行函数转换或计算会导致无法使用索引
- 在明显不会有重复值时使用UNION ALL而不是UNION
  - UNION 会把所有数据放到临时表中后再进行去重操作
  - UNION ALL 不会再对结果集进行去重操作
- 拆分复杂的大SQL为多个小SQL
  - MySQL一个SQL只能使用一个CPU进行计算
  - SQL拆分后可以通过并行执行来提高处理效率

### 6. 数据库操作行为规范
- 超100万行的批量写操作，要分批次多次进行操作
  - 大批量操作可能会造成严重的主从延迟
  - binlog日志为row格式时会产生大量的日志
  - 避免产生大事务操作
- 对于大表使用 pt-online-schema-change 修改表结构
  - 避免大表修改产生的主从延迟
  - 避免在对表字段进行修改时进行锁表
- 禁止为程序使用的账号赋予super 权限
  - 当达到最大连接数限制时，还允许1个有 super 权限的用户连接
  - super权限只能留给DBA处理问题账号使用
- 对于程序连接数据库账号，遵循权限最小原则
  - 程序使用数据库账号只能在一个DB下使用，不准垮库
  - 程序使用的账号原则上不准有drop权限
