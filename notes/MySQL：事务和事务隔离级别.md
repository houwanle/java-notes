# MySQL：事务和事务隔离级别

## 为什么需要事务
事务是数据库管理系统（DBMS）执行过程中的一个逻辑单位（不可再进行分割），由一个有限的数据库操作序列构成（多个DML语句，select语句不包含事务），要不全部成功，要不全部不成功。

> A 给B 要划钱，A 的账户-1000元， B 的账户就要+1000元，这两个update 语句必须作为一个整体来执行，不然A 扣钱了，B 没有加钱这种情况就是错误的。那么事务就可以保证A 、B 账户的变动要么全部一起发生，要么全部一起不发生。

## 事务的特性
>事务应该具有4个属性：原子性、一致性、隔离性、持久性。这四个属性通常称为ACID特性。

### 原子性（atomicity）
一个事务必须被视为一个不可分割的最小单元，整个事务中的所有操作要么全部提交成功，要么全部失败，对于一个事务来说，不能只执行其中的一部分操作。

> 比如：
>   连老师借给李老师1000元：
>    1. 连老师工资卡扣除1000元；
>    2. 李老师工资卡增加1000元；
>
>  整个事务的操作要么全部成功，要么全部失败，不能出现连老师工资卡扣除，但是李老师工资卡不增加的情况。如果原子性不能保证，就会很自然的出现一致性问题。

### 一致性（consistency）
一致性是指事务将数据库从一种一致性转换到另外一种一致性状态，在事务开始之前和事务结束之后数据库中数据的完整性没有被破坏。

> 连老师借给李老师1000元；
>  1. 连老师工资卡扣除1000元；
>  2. 李老师工资卡增加1000元；
>
>  扣除的钱（-500）与增加的钱（500）相加应该为0，或者说连老师和李老师的账户的钱加起来，前后应该不变。

### 持久性（durability）
一旦事务提交，则其所做的修改就会永久保存到数据库中。此时即使系统崩溃，已经提交的修改数据也不会丢失。

### 隔离性（isolation）
一个事务的执行不能被其他事务干扰。即一个事务内部的操作及使用的数据对并发的其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

> 如果隔离性不能保证，会导致什么问题？
> 
>  连老师借给李老师生活费，借了两次，每次都是1000，连老师的卡里开始有10000，李老师的卡里开始有500，从理论上，借完后，连老师的卡里有8000，李老师卡里应该有2500.
>
>  我们将连老师向李老师同时进行的两次转账操作分别称为T1和T2,在现实世界中T1和T2是应该没有关系的，可以先执行完T1,再执行T2,或者先执行完T2，在执行T1,结果都是一样的。但是很不幸，真实的数据中T1和T2
的操作可能交替执行的，如图：

  ![MySQL：隔离性](./pics/MySQL：隔离性.png)

> 如果按照上图中的执行顺序来进行两次转账的话，最终我们看到，老师的账户还剩9000元钱，相当于只扣了1000元钱，但是李老师的账户里却成了2500元，多了1000元，这银行岂不是要亏死了？
>
> 所以对于显示世界中状态转换对应的某些数据库操作来说，不仅要保证这些操作以原子性的方式执行完成，而且要保证其他的状态转换不会影响到本次状态转换，这个规则被称之为隔离性。

## 事务并发引发的问题
我们知道MySQL是一个客户端／服务器架构的软件，对于同一个服务器来说，可以有若干个客户端与之连接，每个客户端与服务器连接上之后，就可以称之为一个会话（Session）。每个客户端都可以在自己的会话中向服务器发出请求语句，一个请求语句可能是某个事务的一部分，也就是对于服务器来说可能同时处理多个事务。

在上面我们说过事务有一个称之为隔离性的特性，理论上在某个事务对某个数据进行访问时，其他事务应该进行排队，当该事务提交之后，其他事务才可以继续访问这个数据，这样的话并发事务的执行就变成了串行化执行。

但是对串行化执行性能影响太大，我们既想保持事务的一定的隔离性，又想让服务器在处理访问同一数据的多个事务时性能尽量高些，当我们舍弃隔离性的时候，可能会带来什么样的数据问题呢？

### 脏读
当一个事务读取到了另外一个事务修改但未提交的数据，被称为脏读。

  ![MySQL：脏读](./pics/MySQL：脏读.png)

1. 在事务A执行过程中，事务A对数据资源进行了修改，事务B读取了事务A修改后的数据；
2. 由于某些原因，事务A并没有完成提交，发生了Rollback操作，则事务B读取的数据就是脏数据。这种读取到另一个事务未提交的数据现象就是脏读。

### 不可重复读
当事务内相同的记录被检索两次，且两次得到的结果不同，此现象成为不可重复读。

  ![MySQL：不可重复读](./pics/MySQL：不可重复读.png)

事务B内读取了两次数据资源，在这两次读取的过程中事务A修改了数据，导致事务B在这两次读取出来的数据不一致。