## ES（一）：Elasticsearch核心概念

### ES 核心概念和原理

#### 1. 什么是搜索：百度、垂直搜索（站内搜索）
搜索：通过一个关键词或一段描述，得到你想要的（相关度高）结果。

#### 2. 如何实现搜索功能？
- 关系型数据库实现搜索功能，存在的问题：性能差、不可靠、结果不准确（相关度低）；

#### 3. 倒排索引、Lucene 和全文检索
- 倒排索引的数据结构：
  - 包含这个关键词的 document list；
  - 关键词在每个 doc 中出现的次数 TF term frequency；
  - 关键词在整个索引中出现的次数 IDF inverse doc frequency；
  - 关键词在当前 doc 中出现的次数；
  - 每个 doc 的 长度，越长相关度越低
- Lucene：jar包，单点，帮我们创建倒排索引，提供了复杂的API
  - Lucene做集群实现搜索，存在的问题：
    - 节点一旦宕机，数据丢失，后果不堪设想；
    - 自己维护，麻烦（自己创建管理索引），单台节点的承载请求能力是有限的，需要人工做负载（雨露均沾）。

#### 4. Elasticsearch：分布式、高性能、高可用、可伸缩、易维护（ES≠搜索引擎）
- 分布式的搜索、存储和数据分析引擎：
- 优点：
  - 面向开发者友好，屏蔽了 Lucene 的复杂性，集群自动发现（cluster discover）；
  - 自动维护数据在多个节点上的建立；
  - 会帮我做搜索请求的负载均衡；
  - 自动维护冗余副本，保证了部分节点宕机的情况下仍然不会有任何数据丢失；
  - ES 基于 Lucene 提供了很多高级功能：符合查询、聚合分析、基于地理位置；
  - 对于大公司，可以构建几百台服务器的大型分布式集群，处理 PB 级别数据；对于小公司，开箱即用，门槛低，上手简单；
  - 相比传数据库，提供了全文检索、同义词处理、相关度排名。聚合分析以及海量数据的近实时（NTR）处理，这些传统数据库完全做不到。
- 应用领域：
  - 百度（全文检索、高亮、搜索推荐）
  - 各大网站的用户行为日志（用户点击、预览、收藏、评论）；
  - BI（Business Inteligence 商业智能），数据分析：数据挖掘统计。
  - Github：代码托管平台，几千亿行代码；
  - ELK：Elasticsearch（数据存储）、Logstash（日志采集）、Kibana（可视化）；

#### 5. ES 核心概念
- Cluster（集群）：每个集群至少包含两个节点；
- Node：集群的每个节点，一个节点不代表一台服务器；
- Field：一个数据字段，与index和type一起，可以定位一个 doc；
- Document：ES 最小的数据单元 Json

  ```json
  {
    "id": "1",
    "name":"小米",
    "price": {
      "标准版":3999,
      "尊享版":4999,
      "定制版":19999
    }
  }
  ```

- Type：逻辑上的数据分类
- Index：一类相同或者类似的 doc，比如一个员工索引、商品索引；

  ```
  Doc <> row
  type <> table
  index <> db
  ```

- Share 分片：
  - 一个 index 包含多个 Shard，默认 5P（primary shard），默认每个 P 分配一个 R，P的数量在创建索引的时候设置，如果想修改，需要重建索引；
  - 每个 Shard 都是一个 Lucene 实例，有完整的创建索引的处理请求能力；
  - ES 会自动在 nodes 上为我们做 shard 均衡；
  - 一个 doc 是不可能同时存在于多个 PShard（primary shard） 中的，但是可以存在于多个 RShard（replica shard） 中；
  - P 和对应的 R 不能同时存在于同一个节点，所以最低的可用配置是两台节点，互为主备；
